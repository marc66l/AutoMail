<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMail Studio | Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background: #000; color: #a1a1aa; scroll-behavior: smooth; }
        .setup-card { background: #09090b; border: 1px solid #18181b; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .guide-img { width: 100%; border-radius: 6px; border: 1px solid #27272a; margin-top: 15px; }
        .info-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%; border: 1px solid #3f3f46;
            font-size: 10px; cursor: help; margin-left: 6px; color: #52525b; position: relative;
        }
        .info-icon:hover::after {
            content: attr(data-tip); position: absolute; background: #18181b; color: #fff;
            padding: 10px; border-radius: 6px; width: 200px; font-size: 11px; z-index: 100;
            border: 1px solid #27272a; bottom: 25px; left: 0; text-transform: none;
        }
        .input-minimal { background: transparent; border-bottom: 1px solid #18181b; outline: none; color: white; transition: 0.3s; }
        .input-minimal:focus { border-color: #fff; }
        #editor { min-height: 200px; border-radius: 8px; background: #050505; border: 1px solid #18181b; color: #fff; }
        .tag-btn { font-size: 9px; text-transform: uppercase; padding: 4px 10px; border: 1px solid #27272a; border-radius: 4px; cursor: pointer; }
        .tag-btn:hover { border-color: #fff; color: #fff; }
    </style>
</head>
<body class="p-6 md:p-12">

    <nav class="flex justify-between items-center mb-16 border-b border-zinc-900 pb-6 max-w-7xl mx-auto">
        <h1 class="text-white text-xs tracking-[0.4em] uppercase font-bold">AutoMail <span class="text-zinc-600">Studio</span></h1>
        <div class="flex gap-6 text-[10px] uppercase tracking-widest">
            <a href="#setup-guide" class="hover:text-white transition">Segítség</a>
            <a href="#main-ui" class="text-white border-b border-white">Vezérlőpult</a>
        </div>
    </nav>

    <div id="setup-guide" class="max-w-4xl mx-auto py-10">
        <h2 class="text-2xl text-white font-light mb-10">Beállítási Útmutató</h2>
        
        <div class="setup-card">
            <span class="text-xs text-zinc-700 uppercase font-bold">Lépés 01</span>
            <h3 class="text-white mt-2">Táblázat & Apps Script</h3>
            <p class="text-sm mt-2">A Google Táblázatban menjen a <b>Bővítmények -> Apps Script</b> menüpontba.</p>
            <img src="kep3.png" class="guide-img">
        </div>

        <div class="setup-card">
            <span class="text-xs text-zinc-700 uppercase font-bold">Lépés 02</span>
            <h3 class="text-white mt-2">Kód beillesztése</h3>
            <p class="text-sm mt-2">Másolja be az oldal alján található Apps Script kódot, majd nyomja meg a Mentés (lemez ikon) gombot.</p>
            <img src="kep4.png" class="guide-img">
        </div>

        <div class="setup-card">
            <span class="text-xs text-zinc-700 uppercase font-bold">Lépés 03</span>
            <h3 class="text-white mt-2">Közzététel</h3>
            <p class="text-sm mt-2"><b>Deploy -> New Deployment</b>. Típus: Web App. Hozzáférés: <b>Anyone</b>. A kapott URL-t másolja be alább.</p>
            <input type="text" id="script_url_input" placeholder="https://script.google.com/..." class="input-minimal w-full py-3 mt-4 text-xs">
            <img src="kep5.png" class="guide-img">
        </div>
    </div>

    <div id="main-ui" class="max-w-7xl mx-auto py-20 border-t border-zinc-900">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-20">
            
            <div class="space-y-12">
                <section>
                    <div class="flex items-center mb-6">
                        <span class="text-[10px] uppercase tracking-widest">01 / Adatforrás</span>
                        <span class="info-icon" data-tip="Válassza ki a táblázatot. A rendszer betölti az oszlopokat és a korábbi mentéseket.">i</span>
                    </div>
                    <button onclick="pickSpreadsheet()" class="text-[10px] uppercase border border-zinc-800 px-6 py-3 hover:bg-white hover:text-black transition">Táblázat kiválasztása</button>
                    
                    <div id="mapping-box" class="hidden mt-8 p-6 bg-zinc-950 border border-zinc-900 rounded-lg space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-xs uppercase">Email oszlop:</span>
                            <select id="emailCol" class="bg-black text-white text-xs border border-zinc-800 p-1"></select>
                        </div>
                        <div class="pt-4">
                            <span class="text-[9px] uppercase text-zinc-600 block mb-3 tracking-widest">Beszúrható mezők:</span>
                            <div id="dynamic-tags" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </section>

                <section class="space-y-6">
                    <div class="flex items-center">
                        <span class="text-[10px] uppercase tracking-widest">02 / Tartalom</span>
                        <span class="info-icon" data-tip="A tárgyban és a törzsben is használhatja a {{Mező}} formátumot.">i</span>
                    </div>
                    <input type="text" id="subject" placeholder="Email tárgya" class="input-minimal w-full py-2">
                    <div id="editor"></div>
                    <div class="flex justify-between">
                        <button onclick="pickFile()" class="text-[9px] uppercase tracking-widest opacity-40 hover:opacity-100 transition">[+] Fájl csatolása</button>
                        <input type="color" id="bgColor" value="#ffffff" class="w-4 h-4 bg-transparent border-none cursor-pointer">
                    </div>
                </section>

                <div class="pt-8 space-y-4">
                    <button onclick="saveEverything()" class="w-full bg-white text-black py-4 text-[10px] font-bold uppercase tracking-[0.4em] hover:bg-zinc-200 transition">Élesítés & Trigger indítása</button>
                    <button onclick="sendTest()" class="w-full border border-zinc-900 py-3 text-[9px] uppercase tracking-[0.2em] hover:text-white transition">Teszt email küldése saját címre</button>
                </div>
            </div>

            <div>
                <div class="sticky top-10">
                    <p class="text-[10px] uppercase tracking-[0.3em] mb-10 text-center opacity-30 italic">Élő előnézet</p>
                    <div id="previewWrap" class="border border-zinc-900 p-10 min-h-[500px] flex items-center justify-center transition-all duration-700">
                        <div class="bg-white p-10 w-full shadow-2xl">
                            <h2 id="prevSub" class="text-xl font-bold text-black mb-6 border-b pb-4"></h2>
                            <div id="prevBody" class="text-sm leading-relaxed text-zinc-700"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '721143767176-gdlp76cpchpaka591l8h2avivk8aabq5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAN6a6dw4x4dQW4e3batn43ds33KxqQkuc';

        let accessToken = null, targetSheetId = null, selectedFileId = null, columnHeaders = [];
        const quill = new Quill('#editor', { theme: 'bubble', placeholder: 'Email üzenet...' });

        const updatePreview = () => {
            let s = document.getElementById('subject').value;
            let b = quill.root.innerHTML;
            columnHeaders.forEach(h => {
                const r = new RegExp(`\\{\\{${h}\\}\\}`, 'g');
                s = s.replace(r, `<span class="text-blue-600">[${h}]</span>`);
                b = b.replace(r, `<span class="bg-zinc-100 px-1 border border-zinc-200">${h}</span>`);
            });
            document.getElementById('prevSub').innerHTML = s || "Tárgy";
            document.getElementById('prevBody').innerHTML = b;
            document.getElementById('previewWrap').style.backgroundColor = document.getElementById('bgColor').value;
        };

        quill.on('text-change', updatePreview);
        document.getElementById('subject').oninput = updatePreview;
        document.getElementById('bgColor').oninput = updatePreview;

        function checkAuth() {
            if (!accessToken) {
                google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly',
                    callback: (resp) => { accessToken = resp.access_token; }
                }).requestAccessToken();
            }
        }

        function pickSpreadsheet() {
            if (!accessToken) return checkAuth();
            gapi.load('picker', () => {
                new google.picker.PickerBuilder().addView(new google.picker.DocsView().setMimeTypes('application/vnd.google-apps.spreadsheet'))
                .setOAuthToken(accessToken).setDeveloperKey(API_KEY)
                .setCallback(async (data) => {
                    if (data.action === google.picker.Action.PICKED) {
                        targetSheetId = data.docs[0].id;
                        await loadProject(targetSheetId);
                    }
                }).build().setVisible(true);
            });
        }

        async function loadProject(id) {
            const resp = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${id}/values/A1:Z1`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const res = await resp.json();
            columnHeaders = res.values[0];

            const sel = document.getElementById('emailCol');
            const tags = document.getElementById('dynamic-tags');
            sel.innerHTML = ''; tags.innerHTML = '';

            columnHeaders.forEach((h, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = h;
                sel.appendChild(opt);
                if(h.toLowerCase().includes('email')) sel.value = i;

                const btn = document.createElement('button');
                btn.className = 'tag-btn';
                btn.innerText = h;
                btn.onclick = () => { quill.insertText(quill.getSelection()?.index || 0, `{{${h}}}`); updatePreview(); };
                tags.appendChild(btn);
            });

            document.getElementById('mapping-box').classList.remove('hidden');

            // Megpróbáljuk betölteni a korábbi mentést
            const url = document.getElementById('script_url_input').value;
            if (url) {
                const loadResp = await fetch(`${url}?sheetId=${id}`);
                const config = await loadResp.json();
                if (config.found) {
                    document.getElementById('subject').value = config.subject;
                    quill.root.innerHTML = config.body;
                    document.getElementById('emailCol').value = config.emailCol;
                    document.getElementById('bgColor').value = config.bgColor;
                    selectedFileId = config.fileId;
                    updatePreview();
                }
            }
        }

        async function saveEverything() {
            const url = document.getElementById('script_url_input').value;
            if (!url) return alert("Hiba: Előbb add meg az Apps Script URL-t!");
            
            const payload = {
                action: 'SAVE',
                sheetId: targetSheetId,
                subject: document.getElementById('subject').value,
                body: quill.root.innerHTML,
                emailCol: document.getElementById('emailCol').value,
                bgColor: document.getElementById('bgColor').value,
                fileId: selectedFileId,
                headers: columnHeaders
            };
            await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("Rendszer élesítve!");
        }

        async function sendTest() {
            const url = document.getElementById('script_url_input').value;
            const payload = {
                action: 'TEST',
                subject: document.getElementById('subject').value,
                body: quill.root.innerHTML,
                bgColor: document.getElementById('bgColor').value,
                fileId: selectedFileId
            };
            await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("Teszt email elküldve!");
        }

        function pickFile() {
            gapi.load('picker', () => {
                new google.picker.PickerBuilder().addView(google.picker.ViewId.DOCS).setOAuthToken(accessToken).setDeveloperKey(API_KEY)
                .setCallback((data) => { if (data.action === google.picker.Action.PICKED) selectedFileId = data.docs[0].id; }).build().setVisible(true);
            });
        }
    </script>
</body>
</html>