<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMail Studio | Clean Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f0f11; color: #d4d4d8; }
        
        /* Glassmorphism & UI elemek */
        .card { background: #18181b; border: 1px solid #27272a; border-radius: 16px; padding: 24px; transition: 0.3s; }
        .card:hover { border-color: #3f3f46; }
        
        .btn-primary { background: white; color: black; font-weight: 600; padding: 12px 24px; border-radius: 8px; transition: 0.2s; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; }
        .btn-primary:hover { background: #e4e4e7; transform: translateY(-1px); }
        
        .btn-secondary { background: transparent; border: 1px solid #3f3f46; color: #a1a1aa; font-weight: 600; padding: 12px 24px; border-radius: 8px; transition: 0.2s; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; }
        .btn-secondary:hover { border-color: white; color: white; }

        .input-field { background: #09090b; border: 1px solid #27272a; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; transition: 0.3s; font-size: 13px; }
        .input-field:focus { border-color: #71717a; }

        /* Szerkesztő */
        #editor { min-height: 250px; background: #09090b; border-radius: 8px; border: 1px solid #27272a; color: #fff; font-size: 15px; margin-top: 10px; }
        
        /* Címkék */
        .variable-tag { background: #27272a; padding: 4px 10px; border-radius: 6px; font-size: 11px; color: #a1a1aa; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .variable-tag:hover { border-color: #52525b; color: white; background: #3f3f46; }

        /* Varázsló lépések */
        .step-circle { width: 28px; height: 28px; background: #27272a; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; color: white; margin-right: 15px; }
        .step-item { display: flex; align-items: start; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #27272a; }
        .step-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="min-h-screen p-6 md:p-10">

    <div class="max-w-7xl mx-auto">
        
        <header class="flex justify-between items-center mb-10 pb-6 border-b border-zinc-800">
            <div>
                <h1 class="text-xl font-bold text-white tracking-wide">AutoMail <span class="text-zinc-500 font-normal">Studio</span></h1>
                <p class="text-xs text-zinc-500 mt-1">Automatizált Email Rendszer</p>
            </div>
            
            <div class="flex bg-[#18181b] p-1 rounded-lg border border-zinc-800">
                <button onclick="toggleView('dashboard')" id="nav-dash" class="px-6 py-2 rounded-md text-xs font-medium text-white bg-zinc-700 shadow transition">Szerkesztő</button>
                <button onclick="toggleView('setup')" id="nav-setup" class="px-6 py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-white transition">Beállítások</button>
            </div>
        </header>

        <div id="view-setup" class="hidden max-w-3xl mx-auto">
            <div class="card">
                <h2 class="text-lg font-semibold text-white mb-6">Rendszer Összekötése</h2>
                
                <div class="step-item">
                    <div class="step-circle">1</div>
                    <div>
                        <h3 class="text-white font-medium mb-1">Motor kód másolása</h3>
                        <p class="text-sm text-zinc-500 mb-3">Ez a kód végzi a háttérmunkát. Kattints a gombra a másoláshoz.</p>
                        <button onclick="copyScriptCode()" class="btn-primary">Kód másolása vágólapra</button>
                    </div>
                </div>

                <div class="step-item">
                    <div class="step-circle">2</div>
                    <div>
                        <h3 class="text-white font-medium mb-1">Google Apps Script beillesztése</h3>
                        <p class="text-sm text-zinc-500">
                            1. Nyisd meg a Google Táblázatodat.<br>
                            2. Menü: <b>Bővítmények (Extensions) > Apps Script</b>.<br>
                            3. Töröld ki az ott lévő szöveget, és <b>illeszd be (Ctrl+V)</b> a most másolt kódot.<br>
                            4. Nyomj a <b>Mentés</b> (lemez) ikonra.
                        </p>
                    </div>
                </div>

                <div class="step-item">
                    <div class="step-circle">3</div>
                    <div>
                        <h3 class="text-white font-medium mb-1">Közzététel (Deploy)</h3>
                        <p class="text-sm text-zinc-500">
                            Jobb felül: <b>Deploy > New Deployment</b>.<br>
                            Típus (fogaskerék): <b>Web App</b>.<br>
                            Who has access: <b>Anyone (Bárki)</b>.<br>
                            A végén másold ki a kapott <b>Web App URL</b>-t.
                        </p>
                    </div>
                </div>

                <div class="step-item border-none">
                    <div class="step-circle">4</div>
                    <div class="w-full">
                        <h3 class="text-white font-medium mb-1">URL mentése</h3>
                        <p class="text-sm text-zinc-500 mb-3">Illeszd be ide az URL-t. A böngésző megjegyzi!</p>
                        <input type="text" id="api-url" oninput="saveUrl(this.value)" placeholder="https://script.google.com/macros/s/..." class="input-field text-green-500 font-mono">
                    </div>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="toggleView('dashboard')" class="btn-secondary w-full">Vissza a Szerkesztőhöz</button>
            </div>
        </div>

        <div id="view-dashboard" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-5 space-y-6">
                
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs uppercase tracking-widest font-semibold text-zinc-500">1. Adatforrás</h3>
                        <span id="status-text" class="text-[10px] text-red-500 font-bold uppercase">Nincs kapcsolat</span>
                    </div>
                    <button onclick="pickerInit()" class="btn-secondary w-full mb-4">Táblázat kiválasztása</button>
                    
                    <div id="mapping-area" class="hidden animate-fade-in border-t border-zinc-800 pt-4 mt-2">
                        <label class="text-[11px] text-zinc-400 block mb-2">Melyik oszlopban van az Email cím?</label>
                        <select id="email-column" class="input-field mb-4 cursor-pointer"></select>
                        
                        <label class="text-[11px] text-zinc-400 block mb-2">Változók beszúrása:</label>
                        <div id="tags-container" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-xs uppercase tracking-widest font-semibold text-zinc-500 mb-4">2. Üzenet Szerkesztése</h3>
                    
                    <input type="text" id="subject-line" placeholder="Email tárgya..." class="input-field text-lg font-bold mb-3" oninput="updatePreview()">
                    
                    <div id="editor"></div>

                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-zinc-800">
                        <button onclick="pickerFile()" class="text-xs font-medium text-zinc-400 hover:text-white flex items-center gap-2 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                            Csatolmány
                        </button>
                        
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-zinc-500">Háttérszín:</span>
                            <input type="color" id="bg-color" value="#f4f4f5" class="w-6 h-6 rounded bg-transparent border-none cursor-pointer" oninput="updatePreview()">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="sendData('TEST')" class="btn-secondary">Teszt Küldése</button>
                    <button onclick="sendData('SAVE')" class="btn-primary">Mentés & Élesítés</button>
                </div>
            </div>

            <div class="lg:col-span-7">
                <div class="sticky top-6">
                    <div class="text-center mb-4">
                        <span class="text-[10px] uppercase tracking-widest text-zinc-600">Élő előnézet</span>
                    </div>
                    
                    <div id="preview-wrapper" class="rounded-xl border border-zinc-800 min-h-[600px] flex items-center justify-center p-8 transition-colors duration-500">
                        <div class="bg-white text-black w-full max-w-[600px] rounded-lg shadow-2xl p-8 md:p-12">
                            <h2 id="preview-subject" class="text-xl font-bold mb-6 border-b pb-4">Tárgy</h2>
                            <div id="preview-body" class="text-sm leading-relaxed text-gray-800">
                                Kezdj el gépelni a szerkesztőben...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // --- KONFIGURÁCIÓ ---
        const CLIENT_ID = '721143767176-gdlp76cpchpaka591l8h2avivk8aabq5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAN6a6dw4x4dQW4e3batn43ds33KxqQkuc';

        // --- EZ A KÓD KERÜL AZ APPS SCRIPTBE (TISZTA VERZIÓ LÁBLÉC NÉLKÜL) ---
        const APPS_SCRIPT_TEXT = `
function doGet(e) {
  var props = PropertiesService.getScriptProperties();
  return ContentService.createTextOutput(props.getProperty(e.parameter.sheetId) || JSON.stringify({found:false})).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  var data = JSON.parse(e.postData.contents);
  var props = PropertiesService.getScriptProperties();
  
  if (data.action === "SAVE") {
    data.found = true;
    props.setProperty(data.sheetId, JSON.stringify(data));
    setupTrigger(data.sheetId);
    return ContentService.createTextOutput("Saved");
  } 
  
  if (data.action === "TEST") {
    sendMail(Session.getActiveUser().getEmail(), data.subject, data.body, data.bgColor, data.fileId, true);
    return ContentService.createTextOutput("Sent");
  }
}

function setupTrigger(id) {
  var triggers = ScriptApp.getProjectTriggers();
  var exists = triggers.some(function(t) { return t.getTriggerSourceId() === id; });
  if (!exists) { ScriptApp.newTrigger("onFormSubmitAction").forSpreadsheet(id).onFormSubmit().create(); }
}

function onFormSubmitAction(e) {
  var sheetId = e.source.getId();
  var config = JSON.parse(PropertiesService.getScriptProperties().getProperty(sheetId));
  if (!config) return;

  var recipient = e.values[config.emailCol];
  var subject = config.subject;
  var body = config.body;

  config.headers.forEach(function(h, i) {
    var regex = new RegExp("{{" + h + "}}", "g");
    subject = subject.replace(regex, e.values[i] || "");
    body = body.replace(regex, e.values[i] || "");
  });

  sendMail(recipient, subject, body, config.bgColor, config.fileId, false);
}

function sendMail(to, sub, body, color, fileId, isTest) {
  var finalColor = color || "#f4f4f5";
  
  // TISZTA HTML - REKLÁM NÉLKÜL
  var html = '<div style="background-color:' + finalColor + '; padding: 40px; font-family: sans-serif;">' +
             '<div style="background-color: white; padding: 40px; border-radius: 8px; max-width: 600px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); color: #333;">' +
             (isTest ? '<div style="background:#fee2e2; color:#b91c1c; padding:10px; text-align:center; font-weight:bold; border-radius:4px; margin-bottom:20px; font-size:12px;">TESZT EMAIL</div>' : '') +
             '<div style="line-height:1.6; font-size:14px;">' + body + '</div>' +
             '</div></div>';

  var options = { htmlBody: html };
  if (fileId) { try { options.attachments = [DriveApp.getFileById(fileId).getBlob()]; } catch(e){} }
  
  GmailApp.sendEmail(to, sub || "Nincs tárgy", "", options);
}
`;

        // --- UI LOGIKA ---
        let accessToken = null, sheetId = null, fileId = null, headers = [];
        const quill = new Quill('#editor', { theme: 'bubble', placeholder: 'Ide írd az üzenetet...' });

        // Betöltéskor
        window.onload = () => {
            const saved = localStorage.getItem('am_url');
            if(saved) document.getElementById('api-url').value = saved;
            toggleView(saved ? 'dashboard' : 'setup');
            updatePreview();
        };

        function toggleView(view) {
            document.getElementById('view-setup').classList.toggle('hidden', view !== 'setup');
            document.getElementById('view-dashboard').classList.toggle('hidden', view !== 'dashboard');
            
            // Gomb stílusok frissítése
            const btnDash = document.getElementById('nav-dash');
            const btnSetup = document.getElementById('nav-setup');
            
            if(view === 'dashboard') {
                btnDash.className = "px-6 py-2 rounded-md text-xs font-medium text-white bg-zinc-700 shadow transition";
                btnSetup.className = "px-6 py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-white transition";
            } else {
                btnSetup.className = "px-6 py-2 rounded-md text-xs font-medium text-white bg-zinc-700 shadow transition";
                btnDash.className = "px-6 py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-white transition";
            }
        }

        function copyScriptCode() {
            navigator.clipboard.writeText(APPS_SCRIPT_TEXT);
            alert("A kód a vágólapra másolva!");
        }

        function saveUrl(val) { localStorage.setItem('am_url', val); }

        function updatePreview() {
            let s = document.getElementById('subject-line').value;
            let b = quill.root.innerHTML;
            const color = document.getElementById('bg-color').value;

            // Változók vizuális cseréje
            headers.forEach(h => {
                const reg = new RegExp(`\\{\\{${h}\\}\\}`, 'g');
                s = s.replace(reg, `<span class="text-blue-600">[${h}]</span>`);
                b = b.replace(reg, `<span class="bg-gray-200 px-1 rounded text-xs font-bold border border-gray-300 mx-1">${h}</span>`);
            });

            document.getElementById('preview-subject').innerHTML = s || "Tárgy";
            document.getElementById('preview-body').innerHTML = b;
            document.getElementById('preview-wrapper').style.backgroundColor = color;
        }
        
        quill.on('text-change', updatePreview);

        // --- GOOGLE API ---
        function auth(cb) {
            if (accessToken) return cb();
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly',
                callback: (r) => { accessToken = r.access_token; cb(); }
            }).requestAccessToken();
        }

        function pickerInit() {
            auth(() => {
                gapi.load('picker', () => {
                    new google.picker.PickerBuilder().addView(new google.picker.DocsView().setMimeTypes('application/vnd.google-apps.spreadsheet'))
                    .setOAuthToken(accessToken).setDeveloperKey(API_KEY)
                    .setCallback(async (data) => {
                        if (data.action === google.picker.Action.PICKED) {
                            sheetId = data.docs[0].id;
                            document.getElementById('status-text').innerText = "Kapcsolódva";
                            document.getElementById('status-text').className = "text-[10px] text-green-500 font-bold uppercase";
                            await loadCols();
                        }
                    }).build().setVisible(true);
                });
            });
        }

        async function loadCols() {
            const r = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/A1:Z1`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const d = await r.json();
            headers = d.values[0];

            const sel = document.getElementById('email-column');
            const tags = document.getElementById('tags-container');
            sel.innerHTML = ''; tags.innerHTML = '';

            headers.forEach((h, i) => {
                // Select opció
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = h;
                sel.appendChild(opt);
                if (h.toLowerCase().includes('mail')) sel.value = i;

                // Tag gomb
                const btn = document.createElement('div');
                btn.className = 'variable-tag';
                btn.innerText = h;
                btn.onclick = () => { quill.insertText(quill.getSelection(true).index, `{{${h}}}`); updatePreview(); };
                tags.appendChild(btn);
            });
            document.getElementById('mapping-area').classList.remove('hidden');
        }

        function pickerFile() {
            auth(() => {
                gapi.load('picker', () => {
                    new google.picker.PickerBuilder().addView(google.picker.ViewId.DOCS).setOAuthToken(accessToken).setDeveloperKey(API_KEY)
                    .setCallback((d) => { if(d.action === google.picker.Action.PICKED) { fileId = d.docs[0].id; alert("Melléklet kiválasztva!"); } }).build().setVisible(true);
                });
            });
        }

        async function sendData(action) {
            const url = document.getElementById('api-url').value;
            if (!url) return alert("Hiba: Nincs URL beállítva!");
            if (!sheetId && action === 'SAVE') return alert("Hiba: Válassz táblázatot!");

            const payload = {
                action: action,
                sheetId: sheetId,
                subject: document.getElementById('subject-line').value,
                body: quill.root.innerHTML,
                emailCol: document.getElementById('email-column').value,
                bgColor: document.getElementById('bg-color').value,
                fileId: fileId,
                headers: headers
            };

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "Küldés...";
            
            try {
                await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert(action === 'SAVE' ? "Sikeres mentés! A rendszer éles." : "Teszt email elküldve!");
            } catch (e) {
                alert("Hiba történt a kommunikációban.");
            } finally {
                btn.innerText = originalText;
            }
        }
    </script>
</body>
</html>