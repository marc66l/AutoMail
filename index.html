<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMail | Minimal Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: #000000; 
            color: #a1a1aa;
            -webkit-font-smoothing: antialiased;
        }
        .input-minimal { 
            background: transparent; 
            border-bottom: 1px solid #27272a; 
            border-radius: 0; 
            outline: none; 
            transition: all 0.4s ease; 
        }
        .input-minimal:focus { 
            border-color: #ffffff; 
            color: #ffffff; 
        }
        #editor { 
            min-height: 250px; 
            border: 1px solid #18181b; 
            border-radius: 8px; 
            color: white; 
            margin-top: 15px;
            background: #09090b;
        }
        .section-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: #52525b;
            margin-bottom: 2rem;
            display: block;
        }
        .btn-minimal {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            border: 1px solid #27272a;
            padding: 12px 24px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-minimal:hover {
            background: #ffffff;
            color: #000000;
            border-color: #ffffff;
        }
        select {
            appearance: none;
            background: transparent;
            border-bottom: 1px solid #27272a;
            padding-bottom: 4px;
            outline: none;
            cursor: pointer;
            font-size: 12px;
        }
        /* Előnézet konténer */
        #previewWrap {
            border: 1px solid #18181b;
            padding: 60px;
            min-height: 550px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 1s ease;
        }
    </style>
</head>
<body class="p-8 md:p-16">

    <div id="login-wall" class="fixed inset-0 z-50 flex items-center justify-center bg-black">
        <button onclick="handleAuthClick()" class="btn-minimal">
            Rendszer Azonosítás
        </button>
    </div>

    <div id="main-ui" class="hidden max-w-6xl mx-auto">
        
        <header class="mb-24 flex justify-between items-end">
            <div>
                <h1 class="text-white text-sm tracking-[0.6em] uppercase font-semibold">AutoMail</h1>
                <p class="text-[9px] text-zinc-600 mt-2 tracking-widest uppercase">Piszkozat v2.0</p>
            </div>
            <div id="sheetStatus" class="text-[9px] uppercase tracking-widest border-l border-zinc-800 pl-4 text-zinc-500">
                Nincs forrás kiválasztva
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-32">
            
            <div class="space-y-20">
                
                <div>
                    <span class="section-label">01 / Adatforrás</span>
                    <div class="flex flex-wrap items-end gap-10">
                        <button onclick="pickSpreadsheet()" class="text-[11px] uppercase border-b border-zinc-700 pb-1 hover:text-white hover:border-white transition">Táblázat kiválasztása</button>
                        
                        <div class="flex gap-6">
                            <div class="flex flex-col">
                                <span class="text-[8px] uppercase mb-2 opacity-40">Email oszlop</span>
                                <select id="emailCol">
                                    <option value="2">C oszlop</option>
                                    <option value="1">B oszlop</option>
                                    <option value="0">A oszlop</option>
                                    <option value="3">D oszlop</option>
                                </select>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[8px] uppercase mb-2 opacity-40">Név oszlop</span>
                                <select id="nameCol">
                                    <option value="1">B oszlop</option>
                                    <option value="0">A oszlop</option>
                                    <option value="2">C oszlop</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-8">
                    <span class="section-label">02 / Üzenet dizájn</span>
                    <input type="text" id="subject" placeholder="Email tárgya" class="input-minimal w-full py-3 text-sm tracking-wide">
                    
                    <div class="flex gap-6 items-center">
                        <button onclick="insertVar('{{Nev}}')" class="text-[9px] uppercase tracking-widest opacity-40 hover:opacity-100 hover:text-white transition">
                            [+] Név beszúrása
                        </button>
                        <button onclick="pickFile()" class="text-[9px] uppercase tracking-widest opacity-40 hover:opacity-100 hover:text-white transition">
                            [+] Fájl csatolása
                        </button>
                    </div>

                    <div id="editor"></div>
                </div>

                <div class="pt-10">
                    <span class="section-label">03 / Véglegesítés</span>
                    <button onclick="saveEverything()" class="w-full btn-minimal py-5">
                        Konfiguráció Élesítése
                    </button>
                </div>
            </div>

            <div class="hidden lg:block">
                <div class="sticky top-16">
                    <p class="text-[9px] uppercase tracking-[0.4em] mb-10 text-center text-zinc-700">Live View</p>
                    <div id="previewWrap">
                        <div class="bg-white p-12 w-full shadow-2xl">
                            <h2 id="prevSub" class="text-xl font-light text-black mb-8 border-b border-zinc-100 pb-6 italic"></h2>
                            <div id="prevBody" class="text-sm leading-relaxed text-zinc-800"></div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end items-center gap-3">
                        <span class="text-[8px] uppercase tracking-widest opacity-30">Háttérszín</span>
                        <input type="color" id="bgColor" value="#ffffff" class="w-4 h-4 rounded-full overflow-hidden border-none bg-transparent cursor-pointer">
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const CONFIG = {
            CLIENT_ID: '721143767176-gdlp76cpchpaka591l8h2avivk8aabq5.apps.googleusercontent.com',
            API_KEY: 'AIzaSyAN6a6dw4x4dQW4e3batn43ds33KxqQkuc', 
            WEB_APP_URL: 'A_TE_APPS_SCRIPT_URL_ED' // Ide írd majd az Apps Script URL-t
        };

        let accessToken = null, selectedFileId = null, targetSheetId = null;

        // Quill szerkesztő inicializálása Bubble témával
        const quill = new Quill('#editor', { 
            theme: 'bubble', 
            placeholder: 'Kezdj el írni, majd jelöld ki a szöveget a formázáshoz...' 
        });

        // Élő előnézet frissítése
        const update = () => {
            document.getElementById('prevSub').innerText = document.getElementById('subject').value || "Tárgy helye";
            document.getElementById('prevBody').innerHTML = quill.root.innerHTML || "Az üzeneted itt fog megjelenni...";
            document.getElementById('previewWrap').style.backgroundColor = document.getElementById('bgColor').value;
        };

        quill.on('text-change', update);
        document.getElementById('subject').oninput = update;
        document.getElementById('bgColor').oninput = update;

        function insertVar(v) {
            const range = quill.getSelection();
            if (range) {
                quill.insertText(range.index, v);
            } else {
                quill.insertText(quill.getLength() - 1, v);
            }
        }

        // Google Bejelentkezés
        function handleAuthClick() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/gmail.send',
                callback: (resp) => {
                    if (resp.access_token) {
                        accessToken = resp.access_token;
                        document.getElementById('login-wall').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('login-wall').style.display = 'none';
                            document.getElementById('main-ui').classList.remove('hidden');
                        }, 600);
                    }
                },
            });
            client.requestAccessToken();
        }

        // Táblázat választó
        function pickSpreadsheet() {
            gapi.load('picker', () => {
                const view = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
                    .setMimeTypes('application/vnd.google-apps.spreadsheet');
                
                const picker = new google.picker.PickerBuilder()
                    .addView(view)
                    .setOAuthToken(accessToken)
                    .setDeveloperKey(CONFIG.API_KEY)
                    .setCallback((data) => {
                        if (data.action === google.picker.Action.PICKED) {
                            targetSheetId = data.docs[0].id;
                            document.getElementById('sheetStatus').innerText = "FORRÁS: " + data.docs[0].name.toUpperCase();
                        }
                    }).build();
                picker.setVisible(true);
            });
        }

        // Fájl választó
        function pickFile() {
            gapi.load('picker', () => {
                const picker = new google.picker.PickerBuilder()
                    .addView(google.picker.ViewId.DOCS)
                    .setOAuthToken(accessToken)
                    .setDeveloperKey(CONFIG.API_KEY)
                    .setCallback((data) => {
                        if (data.action === google.picker.Action.PICKED) {
                            selectedFileId = data.docs[0].id;
                            alert("Dokumentum sikeresen csatolva.");
                        }
                    }).build();
                picker.setVisible(true);
            });
        }

        // Mentés
        async function saveEverything() {
            if (!targetSheetId) {
                alert("Kérlek, válassz ki egy forrás táblázatot!");
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "MENTÉS FOLYAMATBAN...";
            btn.disabled = true;

            const payload = {
                sheetId: targetSheetId,
                subject: document.getElementById('subject').value,
                body: quill.root.innerHTML,
                bgColor: document.getElementById('bgColor').value,
                fileId: selectedFileId,
                emailCol: document.getElementById('emailCol').value,
                nameCol: document.getElementById('nameCol').value
            };
            
            try {
                await fetch(CONFIG.WEB_APP_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(payload) 
                });
                btn.innerText = "SIKERESEN AKTIVÁLVA";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 3000);
            } catch (e) {
                alert("Hiba történt a mentés során.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>