<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMail Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600&display=swap');
        body { font-family: 'Outfit', sans-serif; background: #050505; color: #ececec; }
        .glass-panel { background: rgba(15, 15, 15, 0.6); border: 1px solid #1a1a1a; border-radius: 12px; }
        .input-underlined { background: transparent; border-bottom: 1px solid #222; outline: none; transition: 0.4s; }
        .input-underlined:focus { border-color: #555; }
        #editor { min-height: 200px; border-radius: 8px; background: #0a0a0a; border: 1px solid #151515; color: #fff; }
        .mapping-select { background: #111; border: 1px solid #222; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #888; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #222; }
    </style>
</head>
<body class="p-6 md:p-12">

    <div id="login-wall" class="fixed inset-0 z-50 flex items-center justify-center bg-black">
        <button onclick="handleAuthClick()" class="tracking-[0.4em] text-[10px] uppercase border border-zinc-800 px-10 py-4 hover:bg-white hover:text-black transition duration-700">
            Azonosítás indítása
        </button>
    </div>

    <div id="main-ui" class="hidden max-w-7xl mx-auto">
        
        <header class="flex justify-between items-baseline mb-16 border-b border-zinc-900 pb-8">
            <h1 class="text-lg font-light tracking-tighter">AutoMail <span class="text-zinc-600 font-extralight">/ Studio v3</span></h1>
            <div id="statusInfo" class="text-[9px] uppercase tracking-[0.3em] text-zinc-500 italic">Készenlétben</div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
            
            <div class="lg:col-span-5 space-y-16">
                
                <section>
                    <p class="text-[10px] uppercase tracking-widest text-zinc-600 mb-6">01. Adatforrás párosítása</p>
                    <div class="space-y-6">
                        <button onclick="pickSpreadsheet()" class="text-xs border border-zinc-800 px-4 py-2 hover:border-zinc-400 transition">
                            Táblázat kiválasztása
                        </button>
                        
                        <div id="mapping-area" class="hidden glass-panel p-6 space-y-4 animate-pulse">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-zinc-500 uppercase">Címzett Email</span>
                                <select id="emailCol" class="mapping-select"></select>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-zinc-500 uppercase">Ügyfél Neve</span>
                                <select id="nameCol" class="mapping-select"></select>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="space-y-6">
                    <p class="text-[10px] uppercase tracking-widest text-zinc-600 mb-6">02. Üzenet felépítése</p>
                    <input type="text" id="subject" placeholder="Email tárgya" class="input-underlined w-full py-2 text-sm font-light">
                    
                    <div class="flex gap-4">
                        <button onclick="insertVar('{{Nev}}')" class="text-[9px] text-zinc-500 hover:text-zinc-200 uppercase tracking-widest">[+] Név</button>
                        <button onclick="pickFile()" class="text-[9px] text-zinc-500 hover:text-zinc-200 uppercase tracking-widest">[+] Fájl</button>
                    </div>

                    <div id="editor"></div>
                </section>

                <button onclick="saveEverything()" id="deployBtn" class="w-full bg-zinc-900 border border-zinc-800 py-5 text-[10px] uppercase tracking-[0.5em] hover:bg-white hover:text-black transition-all duration-500">
                    Konfiguráció Élesítése & Trigger
                </button>
            </div>

            <div class="lg:col-span-7">
                <div class="sticky top-12">
                    <div id="previewWrap" class="border border-zinc-900 p-12 min-h-[600px] flex items-center justify-center transition-all duration-1000">
                        <div class="bg-white p-10 w-full max-w-lg shadow-2xl">
                            <h2 id="prevSub" class="text-xl font-semibold text-black mb-6 border-b border-zinc-100 pb-4"></h2>
                            <div id="prevBody" class="text-sm leading-relaxed text-zinc-700"></div>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end gap-2">
                        <input type="color" id="bgColor" value="#050505" class="w-4 h-4 bg-transparent border-none cursor-pointer opacity-20">
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const CONFIG = {
            CLIENT_ID: '721143767176-gdlp76cpchpaka591l8h2avivk8aabq5.apps.googleusercontent.com',
            API_KEY: 'AIzaSyAN6a6dw4x4dQW4e3batn43ds33KxqQkuc',
            WEB_APP_URL: 'A_TE_APPS_SCRIPT_URL_ED'
        };

        let accessToken = null, selectedFileId = null, targetSheetId = null;
        const quill = new Quill('#editor', { theme: 'bubble', placeholder: 'Ide írja az üzenet törzsét...' });

        // LIVE PREVIEW UPDATES
        const update = () => {
            document.getElementById('prevSub').innerText = document.getElementById('subject').value || "Példa Tárgy";
            document.getElementById('prevBody').innerHTML = quill.root.innerHTML || "Üzenet helye...";
            document.getElementById('previewWrap').style.backgroundColor = document.getElementById('bgColor').value;
        };
        quill.on('text-change', update);
        document.getElementById('subject').oninput = update;
        document.getElementById('bgColor').oninput = update;

        function handleAuthClick() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly',
                callback: (resp) => {
                    accessToken = resp.access_token;
                    document.getElementById('login-wall').style.display = 'none';
                    document.getElementById('main-ui').classList.remove('hidden');
                },
            });
            client.requestAccessToken();
        }

        // TÁBLÁZAT ÉS OSZLOP LEKÉRÉS
        function pickSpreadsheet() {
            gapi.load('picker', () => {
                const picker = new google.picker.PickerBuilder()
                    .addView(new google.picker.DocsView().setMimeTypes('application/vnd.google-apps.spreadsheet'))
                    .setOAuthToken(accessToken).setDeveloperKey(CONFIG.API_KEY)
                    .setCallback(async (data) => {
                        if (data.action === google.picker.Action.PICKED) {
                            targetSheetId = data.docs[0].id;
                            document.getElementById('statusInfo').innerText = "Forrás: " + data.docs[0].name;
                            await fetchHeaders(targetSheetId);
                        }
                    }).build();
                picker.setVisible(true);
            });
        }

        async function fetchHeaders(id) {
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${id}/values/A1:Z1`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const result = await response.json();
            const headers = result.values[0];
            
            const emailSelect = document.getElementById('emailCol');
            const nameSelect = document.getElementById('nameCol');
            
            [emailSelect, nameSelect].forEach(s => s.innerHTML = '');
            headers.forEach((h, index) => {
                const opt = `<option value="${index}">${h}</option>`;
                emailSelect.innerHTML += opt;
                nameSelect.innerHTML += opt;
            });

            document.getElementById('mapping-area').classList.remove('hidden', 'animate-pulse');
        }

        function insertVar(v) {
            const range = quill.getSelection();
            quill.insertText(range ? range.index : quill.getLength(), v);
        }

        function pickFile() {
            gapi.load('picker', () => {
                new google.picker.PickerBuilder()
                    .addView(google.picker.ViewId.DOCS)
                    .setOAuthToken(accessToken).setDeveloperKey(CONFIG.API_KEY)
                    .setCallback((data) => {
                        if (data.action === google.picker.Action.PICKED) {
                            selectedFileId = data.docs[0].id;
                            alert("Fájl csatolva: " + data.docs[0].name);
                        }
                    }).build().setVisible(true);
            });
        }

        async function saveEverything() {
            if (!targetSheetId) return alert("Hiba: Nincs táblázat.");
            const btn = document.getElementById('deployBtn');
            btn.innerText = "FOLYAMATBAN...";

            const payload = {
                sheetId: targetSheetId,
                subject: document.getElementById('subject').value,
                body: quill.root.innerHTML,
                bgColor: document.getElementById('bgColor').value,
                fileId: selectedFileId,
                emailCol: document.getElementById('emailCol').value,
                nameCol: document.getElementById('nameCol').value
            };

            await fetch(CONFIG.WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            btn.innerText = "ÉLESÍTVE ✓";
            setTimeout(() => btn.innerText = "KONFIGURÁCIÓ ÉLESÍTÉSE & TRIGGER", 3000);
        }
    </script>
</body>
</html>