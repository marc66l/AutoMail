<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMail Studio | Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #e4e4e7; overflow-x: hidden; }
        
        /* UI Elemek */
        .glass-panel { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; }
        .input-dark { background: #18181b; border: 1px solid #27272a; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; transition: 0.3s; font-size: 13px; }
        .input-dark:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        .btn-primary { background: white; color: black; font-weight: 700; padding: 12px 24px; border-radius: 8px; text-transform: uppercase; letter-spacing: 1px; font-size: 11px; transition: 0.2s; cursor: pointer; }
        .btn-primary:hover { background: #e4e4e7; transform: translateY(-1px); }
        
        .btn-outline { background: transparent; border: 1px solid #3f3f46; color: #a1a1aa; font-weight: 600; padding: 10px 20px; border-radius: 8px; font-size: 11px; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .btn-outline:hover { border-color: white; color: white; }

        /* Login Overlay */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
        
        /* Editor & Tags */
        #editor { min-height: 250px; background: #0d0d0e; border: 1px solid #27272a; border-radius: 8px; color: #fff; font-size: 15px; margin-top: 10px; }
        .tag-pill { background: #27272a; padding: 4px 10px; border-radius: 6px; font-size: 11px; color: #a1a1aa; cursor: pointer; border: 1px solid transparent; transition: 0.2s; user-select: none; }
        .tag-pill:hover { border-color: #52525b; color: white; background: #3f3f46; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }

        .step-num { width: 24px; height: 24px; background: #27272a; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; margin-right: 12px; }
    </style>
</head>
<body class="antialiased">

    <div id="login-screen">
        <div class="text-center space-y-6 max-w-md px-6">
            <div>
                <h1 class="text-4xl font-extrabold text-white tracking-tighter mb-2">AutoMail Studio</h1>
                <p class="text-zinc-500 text-sm font-medium">Készítette: Nagy Marcell</p>
            </div>
            
            <div id="login-loading" class="animate-pulse text-zinc-600 text-xs uppercase tracking-widest">
                Adatok betöltése...
            </div>

            <div id="login-btn-container" class="hidden space-y-4">
                <p class="text-zinc-400 text-sm">A folytatáshoz engedélyezd a Google kapcsolatot.</p>
                <button onclick="initAuth()" class="btn-primary w-full py-4">Belépés Google Fiókkal</button>
                <div class="pt-6 border-t border-zinc-900">
                    <button onclick="hardReset()" class="text-[10px] text-red-900 hover:text-red-500 uppercase font-bold tracking-widest transition">Minden adat törlése (Reset)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-main" class="hidden opacity-0 transition-opacity duration-1000 max-w-7xl mx-auto p-6 md:p-12">
        
        <header class="flex justify-between items-start mb-12 pb-6 border-b border-zinc-800">
            <div>
                <h1 class="text-2xl font-extrabold text-white tracking-tight">AutoMail Studio</h1>
                <p class="text-zinc-500 text-xs font-medium mt-1">Készítette: Nagy Marcell</p>
            </div>
            
            <div class="flex bg-[#18181b] p-1 rounded-lg border border-zinc-800">
                <button onclick="switchTab('editor')" id="tab-editor" class="px-5 py-2 rounded-md text-xs font-bold text-white bg-zinc-700 shadow transition">Szerkesztő</button>
                <button onclick="switchTab('setup')" id="tab-setup" class="px-5 py-2 rounded-md text-xs font-bold text-zinc-500 hover:text-white transition">Beállítás / Motor</button>
            </div>
        </header>

        <div id="view-setup" class="hidden max-w-3xl mx-auto space-y-8">
            <div class="glass-panel p-8">
                <h2 class="text-xl font-bold text-white mb-6">A Rendszer Beüzemelése</h2>
                
                <div class="space-y-6">
                    <div class="flex items-start">
                        <div class="step-num">1</div>
                        <div class="w-full">
                            <h3 class="text-white font-semibold text-sm mb-2">Motor Kódjának Másolása</h3>
                            <p class="text-xs text-zinc-500 mb-3">Kattints a gombra, és a rendszer vágólapra teszi a szükséges Apps Script kódot.</p>
                            <button onclick="copyCode()" class="btn-primary w-full md:w-auto">Kód Másolása</button>
                        </div>
                    </div>

                    <div class="flex items-start">
                        <div class="step-num">2</div>
                        <div>
                            <h3 class="text-white font-semibold text-sm mb-1">Beillesztés a Google-be</h3>
                            <p class="text-xs text-zinc-500 leading-relaxed">
                                1. Nyisd meg a Táblázatod > <b>Bővítmények (Extensions) > Apps Script</b>.<br>
                                2. Törölj ki mindent, és illeszd be a kódodat (Ctrl+V).<br>
                                3. Mentsd el (Lemez ikon).
                            </p>
                        </div>
                    </div>

                    <div class="flex items-start">
                        <div class="step-num">3</div>
                        <div>
                            <h3 class="text-white font-semibold text-sm mb-1">Közzététel (Deploy) - FONTOS!</h3>
                            <p class="text-xs text-zinc-500 leading-relaxed">
                                Kattints: <b>Deploy > New Deployment</b>.<br>
                                Select type: <b>Web App</b>.<br>
                                Who has access: <b>Anyone (Bárki)</b> <span class="text-red-500 font-bold"><-- Ezt ne felejtsd el!</span><br>
                                Másold ki a kapott URL-t.
                            </p>
                        </div>
                    </div>

                    <div class="flex items-start border-t border-zinc-800 pt-6 mt-4">
                        <div class="step-num bg-indigo-600">4</div>
                        <div class="w-full">
                            <h3 class="text-white font-semibold text-sm mb-2">Web App URL megadása</h3>
                            <input type="text" id="api-url" oninput="saveState('url', this.value)" placeholder="https://script.google.com/macros/s/..." class="input-dark font-mono text-indigo-400">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-editor" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-5 space-y-6">
                
                <div class="glass-panel p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest">Adatforrás</h3>
                        <span id="sheet-status" class="text-[10px] text-red-500 font-bold uppercase">Nincs kiválasztva</span>
                    </div>
                    <button onclick="initPicker()" class="btn-outline w-full mb-4">Táblázat Tallózása</button>
                    
                    <div id="mapping-area" class="hidden animate-fade-in border-t border-zinc-800 pt-4">
                        <label class="text-[10px] text-zinc-400 block mb-2 font-bold uppercase">Email Cím Oszlop</label>
                        <select id="email-col" onchange="saveState('col', this.value)" class="input-dark cursor-pointer mb-4 py-2"></select>
                        
                        <label class="text-[10px] text-zinc-400 block mb-2 font-bold uppercase">Változók beszúrása</label>
                        <div id="tags-container" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div class="glass-panel p-6">
                    <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Levél Szerkesztése</h3>
                    <input type="text" id="subject" oninput="saveState('sub', this.value); updatePreview()" placeholder="Email tárgya..." class="input-dark text-lg font-bold mb-2 bg-transparent border-none px-0 py-2 placeholder-zinc-700">
                    <div id="editor"></div>
                    
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-zinc-800">
                        <button onclick="pickFile()" class="text-xs font-bold text-zinc-500 hover:text-white flex items-center gap-2 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                            Csatolmány (Drive)
                        </button>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold text-zinc-600 uppercase">Háttérszín</span>
                            <input type="color" id="bg-color" oninput="saveState('clr', this.value); updatePreview()" value="#f4f4f5" class="w-6 h-6 rounded border-none bg-transparent cursor-pointer">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="execute('TEST')" id="btn-test" class="btn-outline text-center justify-center">Teszt Küldése</button>
                    <button onclick="execute('SAVE')" id="btn-save" class="btn-primary text-center justify-center">Mentés & Élesítés</button>
                </div>
            </div>

            <div class="lg:col-span-7 hidden lg:block">
                <div class="sticky top-6">
                    <p class="text-center text-[10px] uppercase font-bold text-zinc-600 tracking-widest mb-4">Élő Előnézet</p>
                    <div id="preview-box" class="rounded-2xl border border-zinc-800 min-h-[650px] flex items-center justify-center p-12 transition-colors duration-500">
                        <div class="bg-white text-black w-full max-w-[550px] rounded-lg shadow-2xl p-10 md:p-14">
                            <h2 id="prev-sub" class="text-2xl font-bold mb-6 border-b pb-4 text-gray-900">Tárgy</h2>
                            <div id="prev-body" class="text-base leading-relaxed text-gray-800"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // KONFIGURÁCIÓ
        const CLIENT_ID = '721143767176-gdlp76cpchpaka591l8h2avivk8aabq5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAN6a6dw4x4dQW4e3batn43ds33KxqQkuc';

        // EZ A GOOGLE APPS SCRIPT KÓDJA (Amit a felhasználó másolni fog)
        const APPS_SCRIPT_CODE = `
function doGet(e) {
  return ContentService.createTextOutput(PropertiesService.getScriptProperties().getProperty(e.parameter.sheetId) || JSON.stringify({found:false})).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    
    if (data.action === "SAVE") {
      PropertiesService.getScriptProperties().setProperty(data.sheetId, JSON.stringify(data));
      var triggers = ScriptApp.getProjectTriggers();
      if (!triggers.some(function(t) { return t.getTriggerSourceId() === data.sheetId; })) {
        ScriptApp.newTrigger("onFormSubmitAction").forSpreadsheet(data.sheetId).onFormSubmit().create();
      }
      return ContentService.createTextOutput("Saved");
    } 
    
    if (data.action === "TEST") {
      sendMail(Session.getActiveUser().getEmail(), "TESZT: " + data.subject, data.body, data.bgColor, data.fileId, true);
      return ContentService.createTextOutput("Sent");
    }
  } catch (err) { return ContentService.createTextOutput("Error: " + err); }
}

function onFormSubmitAction(e) {
  try {
    var sheetId = e.source.getId();
    var config = JSON.parse(PropertiesService.getScriptProperties().getProperty(sheetId));
    if (!config) return;

    var recipient = e.values[config.emailCol];
    var subject = config.subject;
    var body = config.body;

    config.headers.forEach(function(h, i) {
      var regex = new RegExp("{{" + h + "}}", "g");
      var val = e.values[i] || "";
      subject = subject.replace(regex, val);
      body = body.replace(regex, val);
    });

    sendMail(recipient, subject, body, config.bgColor, config.fileId, false);
  } catch (err) { console.error(err); }
}

function sendMail(to, sub, body, color, fileId, isTest) {
  var html = '<div style="background:' + (color || "#f4f4f5") + ';padding:40px;font-family:sans-serif"><div style="background:white;padding:40px;border-radius:8px;max-width:600px;margin:0 auto;box-shadow:0 2px 10px rgba(0,0,0,0.05);color:#333">' + 
  (isTest ? '<div style="background:#fee2e2;color:#b91c1c;padding:10px;text-align:center;font-weight:bold;margin-bottom:20px">TESZT ÜZEMMÓD</div>' : '') + 
  '<div style="line-height:1.6;font-size:15px">' + body + '</div></div></div>';
  
  var options = { htmlBody: html };
  if (fileId) { try { options.attachments = [DriveApp.getFileById(fileId).getBlob()]; } catch(e){} }
  GmailApp.sendEmail(to, sub, "", options);
}
`;

        // ÁLLAPOT VÁLTOZÓK
        let accessToken = null, headers = [];
        const quill = new Quill('#editor', { theme: 'bubble', placeholder: 'Írd ide a levelet...' });

        // --- 1. LOCAL STORAGE & BETÖLTÉS ---
        
        window.onload = () => {
            // Visszatöltés a memóriából
            const s = localStorage;
            if(s.getItem('am_url')) document.getElementById('api-url').value = s.getItem('am_url');
            if(s.getItem('am_sub')) document.getElementById('subject').value = s.getItem('am_sub');
            if(s.getItem('am_body')) quill.root.innerHTML = s.getItem('am_body');
            if(s.getItem('am_clr')) document.getElementById('bg-color').value = s.getItem('am_clr');

            // UI Kezelés
            setTimeout(() => {
                document.getElementById('login-loading').classList.add('hidden');
                document.getElementById('login-btn-container').classList.remove('hidden');
            }, 500);
        };

        function saveState(key, val) {
            localStorage.setItem('am_' + key, val);
        }

        quill.on('text-change', () => {
            saveState('body', quill.root.innerHTML);
            updatePreview();
        });

        function hardReset() {
            if(confirm("Ez töröl minden beállítást és elfelejti az URL-t. Biztos?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function switchTab(tab) {
            document.getElementById('view-editor').classList.toggle('hidden', tab !== 'editor');
            document.getElementById('view-setup').classList.toggle('hidden', tab !== 'setup');
            
            // Aktív gomb stílus
            const activeClass = "text-white bg-zinc-700 shadow";
            const inactiveClass = "text-zinc-500 hover:text-white";
            
            document.getElementById('tab-editor').className = `px-5 py-2 rounded-md text-xs font-bold transition ${tab === 'editor' ? activeClass : inactiveClass}`;
            document.getElementById('tab-setup').className = `px-5 py-2 rounded-md text-xs font-bold transition ${tab === 'setup' ? activeClass : inactiveClass}`;
        }

        function copyCode() {
            navigator.clipboard.writeText(APPS_SCRIPT_CODE);
            alert("Kód másolva! Illeszd be az Apps Scriptbe.");
        }

        // --- 2. AUTHENTIKÁCIÓ ---

        function initAuth() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly',
                callback: (resp) => {
                    accessToken = resp.access_token;
                    // Sikeres belépés után:
                    document.getElementById('login-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('app-main').classList.remove('hidden');
                        document.getElementById('app-main').classList.remove('opacity-0');
                        
                        // Ha van mentett URL, akkor szerkesztő, ha nincs, akkor setup
                        if(!localStorage.getItem('am_url')) switchTab('setup');
                        else switchTab('editor');

                        // Ha van mentett táblázat, betöltjük
                        if(localStorage.getItem('am_sheetId')) {
                            loadSheet(localStorage.getItem('am_sheetId'), localStorage.getItem('am_sheetName'));
                        }
                    }, 500);
                    updatePreview();
                }
            }).requestAccessToken();
        }

        // --- 3. GOOGLE PICKER & API ---

        function initPicker() {
            gapi.load('picker', () => {
                new google.picker.PickerBuilder()
                    .addView(new google.picker.DocsView().setMimeTypes('application/vnd.google-apps.spreadsheet'))
                    .setOAuthToken(accessToken).setDeveloperKey(API_KEY)
                    .setCallback((d) => {
                        if(d.action === google.picker.Action.PICKED) {
                            const doc = d.docs[0];
                            saveState('sheetId', doc.id);
                            saveState('sheetName', doc.name);
                            loadSheet(doc.id, doc.name);
                        }
                    }).build().setVisible(true);
            });
        }

        async function loadSheet(id, name) {
            const status = document.getElementById('sheet-status');
            status.innerText = "Betöltés...";
            
            try {
                const r = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${id}/values/A1:Z1`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const d = await r.json();
                
                if(!d.values) throw new Error("Üres táblázat");
                headers = d.values[0];

                // UI frissítés
                status.innerText = name;
                status.classList.replace('text-red-500', 'text-green-500');

                const sel = document.getElementById('email-col');
                const tags = document.getElementById('tags-container');
                sel.innerHTML = ''; tags.innerHTML = '';
                
                const savedCol = localStorage.getItem('am_col');

                headers.forEach((h, i) => {
                    // Select feltöltés
                    const opt = document.createElement('option');
                    opt.value = i; opt.innerText = h;
                    if(savedCol == i) opt.selected = true;
                    else if(h.toLowerCase().includes('mail') && !savedCol) opt.selected = true;
                    sel.appendChild(opt);

                    // Tagek
                    const pill = document.createElement('span');
                    pill.className = 'tag-pill';
                    pill.innerText = h;
                    pill.onclick = () => { quill.insertText(quill.getSelection(true).index, `{{${h}}}`); updatePreview(); };
                    tags.appendChild(pill);
                });

                document.getElementById('mapping-area').classList.remove('hidden');
                if(!savedCol) saveState('col', sel.value);

            } catch(e) {
                status.innerText = "Hiba a betöltéskor";
                alert("Nem sikerült elérni a táblázatot. Próbáld meg újra bejelentkezni.");
            }
        }

        function pickFile() {
            gapi.load('picker', () => {
                new google.picker.PickerBuilder().addView(google.picker.ViewId.DOCS).setOAuthToken(accessToken).setDeveloperKey(API_KEY)
                .setCallback((d) => {
                    if(d.action === google.picker.Action.PICKED) {
                        saveState('fileId', d.docs[0].id);
                        alert("Melléklet sikeresen kiválasztva!");
                    }
                }).build().setVisible(true);
            });
        }

        // --- 4. PREVIEW & KÜLDÉS ---

        function updatePreview() {
            let s = document.getElementById('subject').value;
            let b = quill.root.innerHTML;
            const c = document.getElementById('bg-color').value;

            headers.forEach(h => {
                const r = new RegExp(`\\{\\{${h}\\}\\}`, 'g');
                s = s.replace(r, `<span style="color:#4f46e5">[${h}]</span>`);
                b = b.replace(r, `<span style="background:#f3f4f6;border:1px solid #d1d5db;border-radius:4px;padding:0 4px;font-weight:600;font-size:0.9em">${h}</span>`);
            });

            document.getElementById('prev-sub').innerHTML = s || "Tárgy";
            document.getElementById('prev-body').innerHTML = b;
            document.getElementById('preview-box').style.backgroundColor = c;
        }

        async function execute(action) {
            const url = document.getElementById('api-url').value;
            const sheetId = localStorage.getItem('am_sheetId');

            if(!url) return alert("HIBA: Nincs URL megadva a Beállításokban!");
            if(action === 'SAVE' && !sheetId) return alert("HIBA: Válassz táblázatot előbb!");

            const btn = document.getElementById(action === 'TEST' ? 'btn-test' : 'btn-save');
            const originalText = btn.innerText;
            btn.innerText = "Feldolgozás...";

            const payload = {
                action: action,
                sheetId: sheetId,
                subject: document.getElementById('subject').value,
                body: quill.root.innerHTML,
                emailCol: document.getElementById('email-col').value,
                bgColor: document.getElementById('bg-color').value,
                fileId: localStorage.getItem('am_fileId'),
                headers: headers
            };

            try {
                // no-cors mode (opaque response)
                await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert(action === 'SAVE' ? "Sikeres mentés! A rendszer éles." : "Teszt elküldve a saját címedre!");
            } catch (e) {
                alert("Hálózati hiba. Ellenőrizd az URL-t!");
            } finally {
                btn.innerText = originalText;
            }
        }
    </script>
</body>
</html>