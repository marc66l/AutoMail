<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMail | Minimal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap');
        body { font-family: 'Inter', sans-serif; background: #000000; color: #a1a1aa; }
        .input-minimal { background: transparent; border-bottom: 1px solid #27272a; border-radius: 0; outline: none; transition: border-color 0.3s; }
        .input-minimal:focus { border-color: #ffffff; color: #ffffff; }
        #editor { min-height: 200px; border: 1px solid #27272a; border-radius: 4px; color: white; margin-top: 10px; }
        .ql-bubble .ql-editor { font-size: 14px; line-height: 1.6; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #27272a; }
    </style>
</head>
<body class="p-6 md:p-12">

    <div id="login-wall" class="fixed inset-0 z-50 flex items-center justify-center bg-black">
        <button onclick="handleAuthClick()" class="text-sm tracking-[0.3em] uppercase border border-zinc-800 px-8 py-3 hover:bg-white hover:text-black transition duration-500">
            Azonosítás
        </button>
    </div>

    <div id="main-ui" class="hidden max-w-5xl mx-auto">
        
        <header class="flex justify-between items-center mb-20">
            <h1 class="text-xs tracking-[0.5em] uppercase text-white">AutoMail / 01</h1>
            <span id="sheetStatus" class="text-[10px] uppercase tracking-widest text-zinc-600">Nincs kiválasztott forrás</span>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-24">
            
            <div class="space-y-12">
                
                <div class="group">
                    <p class="text-[10px] uppercase tracking-widest mb-4">01 / Táblázat & Oszlopok</p>
                    <div class="flex items-end gap-6">
                        <button onclick="pickSpreadsheet()" class="text-[10px] uppercase border-b border-zinc-800 pb-1 hover:border-white transition">Kiválasztás</button>
                        <select id="emailCol" class="bg-transparent text-xs outline-none border-b border-zinc-800 pb-1 cursor-pointer">
                            <option value="2" class="bg-black">Email (C)</option>
                            <option value="1" class="bg-black">Email (B)</option>
                            <option value="0" class="bg-black">Email (A)</option>
                        </select>
                        <select id="nameCol" class="bg-transparent text-xs outline-none border-b border-zinc-800 pb-1 cursor-pointer">
                            <option value="1" class="bg-black">Név (B)</option>
                            <option value="0" class="bg-black">Név (A)</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-4">
                    <p class="text-[10px] uppercase tracking-widest">02 / Üzenet</p>
                    <input type="text" id="subject" placeholder="Tárgy" class="input-minimal w-full py-2 text-sm">
                    
                    <div class="flex gap-4">
                        <button onclick="insertVar('{{Nev}}')" class="text-[9px] uppercase tracking-tighter opacity-50 hover:opacity-100">+ Név beszúrása</button>
                        <button onclick="pickFile()" class="text-[9px] uppercase tracking-tighter opacity-50 hover:opacity-100">+ Fájl csatolása</button>
                    </div>

                    <div id="editor"></div>
                </div>

                <div class="pt-8">
                    <button onclick="saveEverything()" class="w-full border border-zinc-800 py-4 text-[10px] uppercase tracking-[0.4em] hover:bg-white hover:text-black transition duration-700">
                        Konfiguráció mentése
                    </button>
                </div>
            </div>

            <div class="hidden lg:block relative">
                <div class="sticky top-12">
                    <p class="text-[10px] uppercase tracking-widest mb-8 text-center opacity-30">Előnézet</p>
                    <div id="previewWrap" class="border border-zinc-900 p-12 min-h-[450px] transition-colors duration-1000">
                        <div class="bg-white p-8 text-black shadow-2xl">
                            <h2 id="prevSub" class="text-lg font-light mb-6 border-b border-zinc-100 pb-4 italic"></h2>
                            <div id="prevBody" class="text-sm leading-relaxed opacity-80"></div>
                        </div>
                    </div>
                    <input type="color" id="bgColor" value="#ffffff" class="absolute -bottom-10 right-0 w-4 h-4 bg-transparent border-none cursor-pointer opacity-30 hover:opacity-100 transition">
                </div>
            </div>

        </div>
    </div>

    <script>
        const CONFIG = {
            CLIENT_ID: '721143767176-gdlp76cpchpaka591l8h2avivk8aabq5.apps.googleusercontent.com',
            API_KEY: 'IDE_TEDD_AZ_API_KULCSODAT', 
            WEB_APP_URL: 'A_TE_APPS_SCRIPT_URL_ED'
        };

        let accessToken = null, selectedFileId = null, targetSheetId = null;

        // Bubble téma: csak akkor jelenik meg a toolbar, ha kijelölsz szöveget
        const quill = new Quill('#editor', { theme: 'bubble', placeholder: 'Írd ide az üzenetet...' });

        const update = () => {
            document.getElementById('prevSub').innerText = document.getElementById('subject').value || "Nincs tárgy";
            document.getElementById('prevBody').innerHTML = quill.root.innerHTML;
            document.getElementById('previewWrap').style.backgroundColor = document.getElementById('bgColor').value;
        };

        quill.on('text-change', update);
        document.getElementById('subject').oninput = update;
        document.getElementById('bgColor').oninput = update;

        function insertVar(v) {
            const range = quill.getSelection();
            if (range) quill.insertText(range.index, v);
        }

        function handleAuthClick() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/gmail.send',
                callback: (resp) => {
                    accessToken = resp.access_token;
                    document.getElementById('login-wall').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('login-wall').style.display = 'none';
                        document.getElementById('main-ui').classList.remove('hidden');
                    }, 500);
                },
            });
            client.requestAccessToken();
        }

        function pickSpreadsheet() {
            gapi.load('picker', () => {
                const picker = new google.picker.PickerBuilder()
                    .addView(new google.picker.DocsView().setMimeTypes('application/vnd.google-apps.spreadsheet'))
                    .setOAuthToken(accessToken).setDeveloperKey(CONFIG.API_KEY)
                    .setCallback((data) => {
                        if (data.action === google.picker.Action.PICKED) {
                            targetSheetId = data.docs[0].id;
                            document.getElementById('sheetStatus').innerText = data.docs[0].name.toUpperCase();
                        }
                    }).build();
                picker.setVisible(true);
            });
        }

        function pickFile() {
            gapi.load('picker', () => {
                const picker = new google.picker.PickerBuilder()
                    .addView(google.picker.ViewId.DOCS)
                    .setOAuthToken(accessToken).setDeveloperKey(CONFIG.API_KEY)
                    .setCallback((data) => {
                        if (data.action === google.picker.Action.PICKED) {
                            selectedFileId = data.docs[0].id;
                            alert("Dokumentum csatolva");
                        }
                    }).build();
                picker.setVisible(true);
            });
        }

        async function saveEverything() {
            if (!targetSheetId) return alert("Válassz táblázatot");
            const payload = {
                sheetId: targetSheetId,
                subject: document.getElementById('subject').value,
                body: quill.root.innerHTML,
                bgColor: document.getElementById('bgColor').value,
                fileId: selectedFileId,
                emailCol: document.getElementById('emailCol').value,
                nameCol: document.getElementById('nameCol').value
            };
            
            await fetch(CONFIG.WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("Mentve.");
        }
    </script>
</body>
</html>