<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMail Studio | Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background: #000; color: #a1a1aa; overflow-x: hidden; }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .pulse-red { animation: pulseRed 2s infinite; border: 1px solid #ef4444; color: #ef4444; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .setup-card { border-left: 2px solid #18181b; padding-left: 24px; margin-bottom: 40px; }
        .code-box { display: none; background: #0a0a0a; border: 1px solid #18181b; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 11px; margin-top: 10px; color: #52525b; white-space: pre-wrap; }
        
        #editor { min-height: 200px; background: #050505; border: 1px solid #18181b; color: white; border-radius: 8px; margin-top: 10px; }
        .input-minimal { background: transparent; border-bottom: 1px solid #18181b; outline: none; color: white; transition: 0.3s; }
        .input-minimal:focus { border-color: white; }
    </style>
</head>
<body class="p-6 md:p-12">

    <nav class="flex justify-between items-center mb-16 border-b border-zinc-900 pb-6 max-w-7xl mx-auto">
        <h1 class="text-white text-xs tracking-[0.4em] uppercase font-bold italic">AutoMail Studio</h1>
        <div class="flex gap-4">
            <button onclick="showView('main')" id="btn-main" class="text-[10px] uppercase tracking-widest px-4 py-2 rounded bg-zinc-900 text-white">Vezérlőpult</button>
            <button onclick="showView('help')" id="btn-help" class="text-[10px] uppercase tracking-widest px-4 py-2 rounded pulse-red font-bold">! Segítség</button>
        </div>
    </nav>

    <div id="view-help" class="hidden max-w-4xl mx-auto fade-in">
        <h2 class="text-3xl text-white font-light mb-10">Beállítási útmutató</h2>

        <div class="setup-card">
            <p class="text-xs uppercase text-zinc-500 mb-2">01. lépés</p>
            <h3 class="text-white text-lg">Űrlap és Táblázat (Forms & Sheets)</h3>
            <p class="text-sm mt-2">Hozza létre a Google Űrlapot. A 'Válaszok' (Responses) fülön kattintson a zöld táblázat ikonra. A megnyíló táblázatban lesznek az adatok.</p>
            <img src="kep1.png" class="mt-4 rounded-lg border border-zinc-900 w-full max-w-2xl shadow-xl">
        </div>

        <div class="setup-card">
            <p class="text-xs uppercase text-zinc-500 mb-2">02. lépés</p>
            <h3 class="text-white text-lg">Szkript megnyitása (Extensions -> Apps Script)</h3>
            <p class="text-sm mt-2">A táblázat felső menüjében kattintson: <b>Bővítmények (Extensions) > Apps Script</b>.</p>
            <img src="kep2.png" class="mt-4 rounded-lg border border-zinc-900 w-full max-w-2xl shadow-xl">
        </div>

        <div class="setup-card">
            <p class="text-xs uppercase text-zinc-500 mb-2">03. lépés</p>
            <h3 class="text-white text-lg">Kód beillesztése</h3>
            <p class="text-sm mt-2">Törölje ki az ott lévő kódot, és másolja be ezt:</p>
            <div class="flex gap-4 mt-4">
                <button onclick="toggleCode()" class="text-[10px] border border-zinc-800 px-4 py-2 hover:text-white">KÓD MUTATÁSA</button>
                <button onclick="copyCode()" class="text-[10px] bg-white text-black px-4 py-2 font-bold">MÁSOLÁS</button>
            </div>
            <div id="script-container" class="code-box">/* Ide másold a kódot a válaszból... */</div>
            <img src="kep3.png" class="mt-4 rounded-lg border border-zinc-900 w-full max-w-2xl shadow-xl">
        </div>

        <div class="setup-card">
            <p class="text-xs uppercase text-zinc-500 mb-2">04. lépés</p>
            <h3 class="text-white text-lg">Mentés és Közzététel (Deploy)</h3>
            <p class="text-sm mt-2">Nyomja meg a Mentés (lemez) ikont. Ezután: <b>Közzététel (Deploy) > Új közzététel (New deployment)</b>. <br>Típus: <b>Webalkalmazás (Web App)</b>. Hozzáférés: <b>Bárki (Anyone)</b>.</p>
            <img src="kep4.png" class="mt-4 rounded-lg border border-zinc-900 w-full max-w-2xl shadow-xl">
        </div>

        <div class="setup-card">
            <p class="text-xs uppercase text-zinc-500 mb-2">05. lépés</p>
            <h3 class="text-white text-lg">URL beillesztése</h3>
            <p class="text-sm mt-2">Másolja ki a kapott Web App URL-t és illessze be ide:</p>
            <input type="text" id="setup-url" oninput="document.getElementById('main-url').value = this.value" placeholder="https://script.google.com/..." class="input-minimal w-full py-4 text-xs font-mono">
        </div>

        <div class="text-center py-20">
            <button onclick="showView('main')" class="bg-white text-black px-12 py-4 font-bold uppercase tracking-widest text-[10px]">Vissza a vezérlőhöz</button>
        </div>
    </div>

    <div id="view-main" class="max-w-7xl mx-auto fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-20">
            
            <div class="space-y-12">
                <section>
                    <p class="text-[10px] uppercase tracking-widest mb-6 opacity-40">01 / Táblázat kiválasztása</p>
                    <button onclick="pickSpreadsheet()" class="text-[10px] uppercase border border-zinc-800 px-6 py-3 hover:bg-white hover:text-black transition">Tallózás</button>
                    
                    <div id="mapping-box" class="hidden mt-8 p-6 bg-zinc-950 border border-zinc-900 rounded-lg animate-pulse">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-[10px] uppercase font-bold text-zinc-400">Email oszlop:</span>
                            <select id="emailCol" class="bg-black text-white text-xs border border-zinc-800 p-1 rounded"></select>
                        </div>
                        <div id="dynamic-tags" class="flex flex-wrap gap-2"></div>
                    </div>
                </section>

                <section>
                    <p class="text-[10px] uppercase tracking-widest mb-6 opacity-40">02 / Üzenet szerkesztése</p>
                    <input type="text" id="subject" placeholder="Tárgy" class="input-minimal w-full py-2 mb-4">
                    <div id="editor"></div>
                    <div class="flex justify-between items-center mt-4">
                        <button onclick="pickFile()" class="text-[9px] uppercase tracking-widest opacity-40 hover:opacity-100 transition">[+] Melléklet</button>
                        <div class="flex items-center gap-3">
                            <span class="text-[9px] uppercase text-zinc-600">Email háttere:</span>
                            <input type="color" id="bgColor" value="#f3f4f6" class="w-6 h-6 bg-transparent border-none cursor-pointer">
                        </div>
                    </div>
                </section>

                <div class="pt-10 space-y-4">
                    <input type="hidden" id="main-url">
                    <button onclick="saveAll()" class="w-full bg-white text-black font-bold py-5 text-[10px] uppercase tracking-[0.4em] hover:bg-zinc-200 transition">Élesítés & Trigger indítása</button>
                    <button onclick="testNow()" class="w-full border border-zinc-900 py-3 text-[9px] uppercase tracking-[0.2em] hover:text-white transition">Teszt küldése (Saját címre)</button>
                </div>
            </div>

            <div class="hidden lg:block">
                <div class="sticky top-10">
                    <p class="text-[10px] uppercase tracking-[0.3em] mb-10 text-center opacity-30 italic">Élő előnézet</p>
                    <div id="previewWrap" class="border border-zinc-900 p-10 min-h-[500px] flex items-center justify-center rounded-2xl transition-all duration-1000">
                        <div class="bg-white p-8 w-full shadow-2xl rounded-lg">
                            <h2 id="prevSub" class="text-xl font-bold text-black mb-4 border-b pb-4"></h2>
                            <div id="prevBody" class="text-sm leading-relaxed text-zinc-700"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API ADATOK
        const CLIENT_ID = '721143767176-gdlp76cpchpaka591l8h2avivk8aabq5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAN6a6dw4x4dQW4e3batn43ds33KxqQkuc';

        let accessToken = null, targetSheetId = null, selectedFileId = null, columnHeaders = [];
        const quill = new Quill('#editor', { theme: 'bubble', placeholder: 'Ide írd a levelet...' });

        // NÉZETVÁLTÓ
        function showView(view) {
            document.getElementById('view-main').classList.toggle('hidden', view !== 'main');
            document.getElementById('view-help').classList.toggle('hidden', view !== 'help');
        }

        function toggleCode() {
            const box = document.getElementById('script-container');
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
        }

        function copyCode() {
            // Ide illesztheted az Apps Script kódot a könnyű másoláshoz
            const code = `/* Itt az Apps Script kód */`; 
            navigator.clipboard.writeText(code); alert("Kód másolva!");
        }

        // PREVIEW MOTOR
        const updatePreview = () => {
            let s = document.getElementById('subject').value;
            let b = quill.root.innerHTML;
            columnHeaders.forEach(h => {
                const r = new RegExp(`\\{\\{${h}\\}\\}`, 'g');
                s = s.replace(r, `<span class="text-blue-600">[${h}]</span>`);
                b = b.replace(r, `<span class="bg-zinc-100 px-1 border border-zinc-200 text-black font-bold">${h}</span>`);
            });
            document.getElementById('prevSub').innerHTML = s || "Tárgy";
            document.getElementById('prevBody').innerHTML = b;
            document.getElementById('previewWrap').style.backgroundColor = document.getElementById('bgColor').value;
        };

        quill.on('text-change', updatePreview);
        document.getElementById('subject').oninput = updatePreview;
        document.getElementById('bgColor').oninput = updatePreview;

        // GOOGLE PICKER
        function pickSpreadsheet() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly',
                callback: (resp) => {
                    accessToken = resp.access_token;
                    gapi.load('picker', () => {
                        new google.picker.PickerBuilder().addView(new google.picker.DocsView().setMimeTypes('application/vnd.google-apps.spreadsheet'))
                        .setOAuthToken(accessToken).setDeveloperKey(API_KEY)
                        .setCallback(async (data) => {
                            if (data.action === google.picker.Action.PICKED) {
                                targetSheetId = data.docs[0].id;
                                await loadData(targetSheetId);
                            }
                        }).build().setVisible(true);
                    });
                }
            }).requestAccessToken();
        }

        async function loadData(id) {
            const resp = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${id}/values/A1:Z1`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const res = await resp.json();
            columnHeaders = res.values[0];

            const sel = document.getElementById('emailCol');
            const tags = document.getElementById('dynamic-tags');
            sel.innerHTML = ''; tags.innerHTML = '';

            columnHeaders.forEach((h, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = h;
                sel.appendChild(opt);
                if(h.toLowerCase().includes('mail')) sel.value = i;

                const btn = document.createElement('button');
                btn.className = 'text-[9px] uppercase tracking-widest border border-zinc-800 px-3 py-1 hover:border-white transition';
                btn.innerText = h;
                btn.onclick = () => { quill.insertText(quill.getSelection()?.index || 0, `{{${h}}}`); updatePreview(); };
                tags.appendChild(btn);
            });
            document.getElementById('mapping-box').classList.remove('hidden');
            document.getElementById('mapping-box').classList.remove('animate-pulse');
        }

        // --- KOMMUNIKÁCIÓ AZ APPS SCRIPTEL ---
        async function saveAll() {
            const url = document.getElementById('main-url').value;
            if (!url) return alert("Hiba: Előbb add meg az URL-t a Segítség menüben!");
            
            const payload = {
                action: 'SAVE',
                sheetId: targetSheetId,
                subject: document.getElementById('subject').value,
                body: quill.root.innerHTML,
                emailCol: document.getElementById('emailCol').value,
                bgColor: document.getElementById('bgColor').value,
                fileId: selectedFileId,
                headers: columnHeaders
            };
            await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("Rendszer sikeresen élesítve!");
        }

        async function testNow() {
            const url = document.getElementById('main-url').value;
            if (!url) return alert("URL hiányzik!");
            const payload = {
                action: 'TEST',
                subject: document.getElementById('subject').value,
                body: quill.root.innerHTML,
                bgColor: document.getElementById('bgColor').value,
                fileId: selectedFileId
            };
            await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("A teszt emailt elküldtük a Te címedre!");
        }

        function pickFile() {
            gapi.load('picker', () => {
                new google.picker.PickerBuilder().addView(google.picker.ViewId.DOCS).setOAuthToken(accessToken).setDeveloperKey(API_KEY)
                .setCallback((data) => { if (data.action === google.picker.Action.PICKED) selectedFileId = data.docs[0].id; }).build().setVisible(true);
            });
        }
    </script>
</body>
</html>